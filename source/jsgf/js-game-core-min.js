/*!
 * @project JSDK JavaScript Development Kit
 * @copyright Copyright(c) 2004-2012, Dragonfly.org. All rights reserved.
 * @license LGPLv3
 * 
 * @version 0.2
 * @author feng.chun
 * @date 2010-11-15
 * @date 2011-04-14
 * @date 2011-10-19
 * 
 * @version 0.1
 * @author feng.chun
 * @date 2010-10-6
 * 
 * @requires /core/js-core.js
 * @requires /core/js-mathphys.js
 * @requires /core/js-thread.js
 * @requires /core/js-input.js
 * @requires /js2d/js-2d-core.js
 */
js.lang.System.namespace("js.game.collision");(function(){var c=js.lang.System,f=js.core.Dom,e=js.core.Dom.$,d=js.core.Event,b=js.math.MathTool,a=js.math.Geom2D;js.game.Sprite=function(g){js.game.Sprite.superclass.constructor.apply(this,arguments);this._dir=g["dir"]||b.RADIAN_0;this._imageSrc=g["imageSrc"];this._frameSeqs=g["frameSeqs"];this._frameKey=g["frameSeqKey"];this._frameIndex=0;this._aabbs={};this.createEvent("turning");this.createEvent("turned");};c.extend(js.game.Sprite,js.d2.View,{getImageSrc:function(){return this._imageSrc;},paint:function(g){if(this._isD){return;}this.fireEvent("painting");g.drawImage(this.getFrame());this.fireEvent("painted");},getFrame:function(){var h=c.isUndefined(arguments[0])?this._frameIndex:arguments[0],g=arguments[1]||this._frameKey;var k=this._frameSeqs[g];if(!k){throw new Error();}var j=k[h];if(!j){throw new Error();}if(!this._isV){return{id:this._id,visible:false};}else{return{id:this._id,x:this._x,y:this._y,z:this._z,opacity:this._opacity,src:this._imageSrc,offsetX:j[0],offsetY:j[1],width:this._w,height:this._h,visible:true};}},setFrameIndex:function(g){if(g in this._frameSeqs[this._frameKey]){this._frameIndex=g;}else{this._frameIndex=0;}},setFrameSeqKey:function(g){if(g in this._frameSeqs){this._frameKey=g;}},getFrameSeqKey:function(){return this._frameKey;},nextFrame:function(){var g=this._frameSeqs[this._frameKey];if(!g){throw new Error();}this._frameIndex=this._frameIndex>=(g.length-1)?0:this._frameIndex+1;},prevFrame:function(){var g=this._frameSeqs[this._frameKey];if(!g){throw new Error();}this._frameIndex=this._frameIndex<=0?g.length-1:this._frameIndex-1;},getFrameSeq:function(g){return g?this._frameSeqs[g]:this._frameSeqs;},setFrameSeq:function(g,h){return this._frameSeqs[g]=h;},getDir:function(){return this._dir;},turn:function(g){if(c.isUndefined(g)){return;}this.fireEvent("turning",g);this._dir=g;this.fireEvent("turned",g);},moveWith:function(g){var h=b.polar2XY(g,this.getDir());this.move(h[0],h[1]);},setAABB:function(g,h){this._aabbs[g]=new js.game.collision.AABB(this,h);},getAABB:function(g){return this._aabbs[g];}});js.game.TiledLayer=function(g){js.game.TiledLayer.superclass.constructor.apply(this,arguments);this._src=g["src"];this._cellSize=g["cell_size"];this._tileSet=g["tile_set"];this._data=null;this._paintRect=null;this.createEvent("painted");};c.extend(js.game.TiledLayer,js.d2.View,{_check:function(h,j,g){if(!g||g.length<1||isNaN(h)||isNaN(j)){return false;}var i=[g[0].length,g.length];return(h<0||h>=i[0]||j<0||j>=i[1])?false:true;},_getCellId:function(h,g){return this.getId()+"_"+h+"_"+g;},_getImage:function(j,i,m){var l=this._tileSet?this._tileSet[m]:String(m).split(","),g=this._cellSize[0],k=this._cellSize[1];return{id:this._getCellId(j,i),src:this._src,width:g,height:k,offsetX:l[0],offsetY:l[1],x:this._x+g*j,y:this._y+k*i};},paint:function(h){if(!this.isVisible()||!this._data){return;}var r=a.intersectsRect(this.getPaintRect(),{x:0,y:0,w:this._data[0].length,h:this._data.length});if(!r){return;}var t=r.x,s=r.y,u=r.w,p=r.h;var q=e(this.getId());if(!q){q=h.drawElement("div",{id:this.getId()});}var v=document.createDocumentFragment();for(var o=s,n=s+p;o<n;o++){for(var m=t,l=t+u;m<l;m++){var k=this.getCell(m,o);var g=h.createImage(this._getImage(m,o,k));g.setAttribute("jsdk_jsgf_tileIndex",k);v.appendChild(g);this.fireEvent("painted",g,k,[m,o]);}}q.appendChild(v);},getCellBound:function(i,h){var j=this._cellSize[0],g=this._cellSize[1];return{x:this._x+i*j,y:this._y+h*g,w:j,h:g};},getCellSize:function(){return this._cellSize;},getCell:function(i,h){if(!this._check(i,h,this._data)){var g=e(this._getCellId(i,h));if(g){return g.getAttribute("jsdk_jsgf_tileIndex");}else{return null;}}return this._data[h][i];},isVisibleCell:function(i,h){var g=e(this._getCellId(i,h));return g?true:false;},setCell:function(h,g,i){if(!this._check(h,g,this._data)){throw new Error();}this._data[g][h]=i;},fillCells:function(k,g,o,n,m){if(!this._check(k+o,g+n,this._data)){throw new Error();}for(var l=k;l<o;l++){for(var h=g;l<n;l++){this.setCell(l,h,m);}}},getPaintRect:function(){if(!this._paintRect){this._paintRect={x:0,y:0,w:this._w,h:this._h};}return this._paintRect;},_setNumber:function(h,j,i,g){if(!c.isUndefined(j)){this._paintRect[h]=j;}},setPaintRect:function(h,g,k,j){if(!this._paintRect){this._paintRect={x:0,y:0,w:this._w,h:this._h};}var i=this.getSize();this._setNumber("x",h);this._setNumber("y",g);this._setNumber("w",k);this._setNumber("h",j);},movePaintRect:function(h,g){var i=this.getPaintRect();this.setPaintRect(i.x+h,i.y+g);},setData:function(g){if(!g||g.length<1||c.isUndefined(g[0][0])){this._data=null;this.setSize(0,0);}else{this._data=g;this.setSize(g[0].length,g.length);}},getData:function(){return this._data;},getCellXY:function(g,j){var i=Math.floor((g-this._x)/this._cellSize[0]),h=Math.floor((j-this._y)/this._cellSize[1]);return[i,h];},getCellByXY:function(g,i){var h=this.getCellXY(g,i);return this.getCell(h[0],h[1]);}});c.augment(js.game.TiledLayer,js.core.EventProvider);js.game.collision.AABB=function(g,h){this.sprite=g;this.collisionRect=h?h:{x:0,y:0,w:g.getWidth(),h:g.getHeight()};};js.game.collision.AABB.prototype={getBoundingBox:function(){var g=this.sprite.getBound();return{x:g.x+this.collisionRect.x,y:g.y+this.collisionRect.y,w:this.collisionRect.w,h:this.collisionRect.h};},isDestoryed:function(){return this.sprite.isDestoryed();},collidesWith:function(g){if(!g||this.isDestoryed()||(g.isDestoryed&&g.isDestoryed())){return false;}var h=(g instanceof js.game.collision.AABB)?g.getBoundingBox():g;return a.intersectsRect(this.getBoundingBox(),h)!=null;},collidesWithTiles:function(h,j){if(!h||!j||this.isDestoryed()||h.isDestoryed()){return false;}var k=this.getBoundingBox(),g=this.sprite.getDir(),i=a.getRectPoints(k);return i.some(function(o,n){var m=h.getCellXY(o[0],o[1]);if(!h.isVisibleCell(m[0],m[1])){return false;}var l=h.getCell(m[0],m[1]);return !c.isUndefined(l)&&j.indexOf(l)>=0;},this);},avoidTo:function(h){if(!(h instanceof js.game.collision.AABB)||h.isDestoryed()){return false;}var g=a.avoidToRect(this.getBoundingBox(),h.getBoundingBox(),this.sprite.getDir());if(g){this.sprite.setXY(g[0]-this.collisionRect.x,g[1]-this.collisionRect.y);return true;}return false;},avoidToTiles:function(h,j){if(!h||!j||this.isDestoryed()||h.isDestoryed()){return false;}var k=this.getBoundingBox(),g=this.sprite.getDir(),i=a.getRectPoints(k);return i.some(function(q,o){var n=h.getCellXY(q[0],q[1]);if(!h.isVisibleCell(n[0],n[1])){return false;}var m=h.getCell(n[0],n[1]);if(c.isUndefined(m)||j.indexOf(m)<0){return false;}var l=a.avoidToRect(k,h.getCellBound(n[0],n[1]),g);if(l){this.sprite.setXY(l[0]-this.collisionRect.x,l[1]-this.collisionRect.y);return true;}},this);},limitIn:function(g){if(!g||this.isDestoryed()){return false;}var h=this.getBoundingBox();if(a.limitInRect(h,g)){this.sprite.setXY(h.x-this.collisionRect.x,h.y-this.collisionRect.y);return true;}return false;},isInBox:function(h){if(!h||this.isDestoryed()||(h.isDestoryed&&h.isDestoryed())){return false;}var i=this.getBoundingBox(),g=(h instanceof js.game.collision.AABB)?h.getBoundingBox():h;return a.containsRect(g,i);}};js.game.GameStatus={UNSTART:-1,RUNNING:1,PAUSED:2,ENDED:3};js.game.Game=function(g){this._id=g["id"]||c.getUUID();this._status=js.game.GameStatus.UNSTART;this._config=g;this.createEvent("starting");this.createEvent("started");this.createEvent("resuming");this.createEvent("resumed");this.createEvent("pausing");this.createEvent("paused");this.createEvent("ending");this.createEvent("ended");this._initCanvas();};js.game.Game.prototype={_initCanvas:function(){if(e(this.getId()+"_canvas")){return;}this._canvas=new js.d2.Canvas({id:this.getId()+"_canvas",background:this._config["background"],viewWindow:this._config["viewWindow"],x:this._config["x"],y:this._config["y"],width:this._config["width"],height:this._config["height"]});},getThread:function(){return this._thread;},getConfig:function(g){return c.isUndefined(g)?this._config:this._config[g];},watchFPS:function(g){var h={};if(c.isBoolean(g)){if(g){h["scope"]=this._canvas;h["fn"]=function(i){this.printFPS(i);};}else{h=null;}}else{h["scope"]=g||this._canvas;h["fn"]=function(i){this.printFPS(i);};}this._config["fpsCallback"]=h;if(this._thread!=null){this._thread.setFPSCallback(h);}},getId:function(){return this._id;},getCanvas:function(){return this._canvas;},getStatus:function(){return this._status;},isRunning:function(){return this.getStatus()==js.game.GameStatus.RUNNING;},isPaused:function(){return this.getStatus()==js.game.GameStatus.PAUSED;},isEnded:function(){return this.getStatus()==js.game.GameStatus.ENDED;},start:function(){this._initCanvas();this.fireEvent("starting");this._thread=new c.Thread(this,{interval:this._config["interval"],fpsMax:this._config["fpsMax"]});this._thread.setFPSCallback(this._config["fpsCallback"]);this._thread.start();this._status=js.game.GameStatus.RUNNING;this.fireEvent("started");},resume:function(){this.fireEvent("resuming");this._status=js.game.GameStatus.RUNNING;this._thread.resume();this.fireEvent("resumed");},pause:function(){this.fireEvent("pausing");this._status=js.game.GameStatus.PAUSED;this._thread.suspend();this.fireEvent("paused");},end:function(){this.fireEvent("ending");this._status=js.game.GameStatus.ENDED;this._thread.stop();this._thread=null;this.fireEvent("ended");},run:function(){}};c.augment(js.game.Game,js.core.EventProvider);c.augment(js.game.Game,js.input.KeyBufferProvider);c.augment(js.game.Game,js.input.MouseProvider);js.game.Mission=function(g){this._config=g;this._s=false;this.createEvent("starting");this.createEvent("started");this.createEvent("running");this.createEvent("completed");this.createEvent("failed");};js.game.Mission.prototype={getConfig:function(g){return g?this._config[g]:this._config;},isStarted:function(){return this._s;},setStarted:function(g){return this._s=g;},start:function(g){},run:function(g){},fail:function(){this._s=false;this.fireEvent("failed");},complete:function(){this._s=false;this.fireEvent("completed");}};c.augment(js.game.Mission,js.core.EventProvider);js.game.MissionManager=function(){this._missions=[];this._missionIndex=-1;this._onMission={};};js.game.MissionManager.prototype={_subscribeMission:function(i,h){if(!this._onMission){return;}var g=this._onMission[h];if(g){i.subscribe(h,g);}},_unsubscribeMission:function(i,h){if(!this._onMission){return;}var g=this._onMission[h];if(g){i.unsubscribe(h,g);}},_loadMission:function(g){if(g){this._subscribeMission(g,"starting");this._subscribeMission(g,"started");this._subscribeMission(g,"running");this._subscribeMission(g,"completed");this._subscribeMission(g,"failed");this._missions.push(g);}},loadMissions:function(g){if(!c.isArray(g)){this._loadMission(g);}else{g.forEach(function(h){this._loadMission(h);},this);}},_unloadMission:function(h){var g=this._missions[h];if(!g){return;}this._unsubscribeMission(g,"starting");this._unsubscribeMission(g,"started");this._unsubscribeMission(g,"running");this._unsubscribeMission(g,"completed");this._unsubscribeMission(g,"failed");},unloadMissions:function(){this._missions.forEach(function(g,h){this._unloadMission(h);},this);this._missions=[];},getMission:function(g){return this._missions[c.isUndefined(g)?this._missionIndex:g];},getNextMission:function(){return this.getMission(++this._missionIndex);},hasNextMission:function(){return(this._missionIndex+1)<this._missions.length;},on:function(g,h){this._onMission[g]=h;},getMissionIndex:function(){return this._missionIndex;},reset:function(){this._missionIndex=-1;}};}());