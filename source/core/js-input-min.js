/*!
 * @project JSDK JavaScript Development Kit
 * @copyright Copyright(c) 2004-2012, Dragonfly.org. All rights reserved.
 * @license LGPLv3
 * 
 * @version 0.1
 * @author feng.chun
 * @date 2011-03-24
 * @date 2011-04-14
 * @date 2011-09-05
 *  
 * @requires /core/js-core.js
 */
js.lang.System.namespace("js.input");js.input.KEY={BACK_SPACE:8,TAB:9,ENTER:13,SHIFT:16,CONTROL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,PRINTSCREEN:44,INSERT:45,DELETE:46,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,PLUS:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,META:224};js.input.KeyBufferProvider=function(){};js.input.KeyBufferProvider.prototype={resetKeyBuffer:function(){this._KEY_MARK={};this._holdBuffer=0;this._holdKeys=[];this._keyLog=[];},getPressedKeyLog:function(b){if(!this._keyLog){return null;}var a=this._keyLog.length;if(a==0){return null;}b=(!b)?a:(b>a?a:b);return this._keyLog.slice(0,b);},getHoldKeys:function(b){if(!this._holdKeys){return null;}if(!b){return this._holdKeys;}var a=b.join(",")+",";return this._holdKeys.filter(function(c){return a.indexOf(c+",")>-1;});},_isKeyHold:function(a){if(!this._KEY_MARK){return false;}return(this._holdBuffer&this._KEY_MARK[a])!=0;},isKeyHold:function(a){if(js.lang.System.isArray(a)){return a.every(function(b){return this._isKeyHold(b);},this);}else{return this._isKeyHold(a);}},isKeyLastest:function(b){if(!this._keyLog){return false;}var a=this._keyLog.length;if(a==0){return false;}var d=(js.lang.System.isArray(b))?b.length:1;if(a<d){return false;}var c=this._keyLog.slice(0,d);return c&&c.toString()==b.toString();},isKeyRepeat:function(b,c){var a=this.getLastestKeys(c);if(a.length!=c){return false;}return a.every(function(d){return d.code==b;});},setPressedKeyLoggable:function(a){this._keyLoggable=a;},isPressedKeyLoggable:function(){return this._keyLoggable?true:false;},onKeyHold:function(c,b,g){if(!c){return;}if(!this._KEY_MARK){this.resetKeyBuffer();}var m=null,h=null,a=null,j=null;if(b){m=b["fn"];h=b["scope"];}if(g){a=g["fn"];j=g["scope"];}var n=c["keys"],e=!n||n.length==0;if(e){c["keys"]=[];n=[];if(c["shift"]){c["keys"].push(js.input.KEY.SHIFT);n.push(js.input.KEY.SHIFT);}if(c["alt"]){c["keys"].push(js.input.KEY.ALT);n.push(js.input.KEY.ALT);}if(c["ctrl"]){c["keys"].push(js.input.KEY.CONTROL);n.push(js.input.KEY.CONTROL);}}for(var f=0,l=n.length;f<l;f++){this._KEY_MARK[n[f]]=1<<f;}this.onKeyDown(c,{fn:function(o,i){this._holdBuffer|=this._KEY_MARK[i[0]];if(!this._holdKeys.contains(i[0])){this._holdKeys.push(i[0]);}if(this._keyLoggable){if(this._keyLog.length>=32){this._keyLog.shift();}this._keyLog.insertAt(0,{code:i[0],time:new Date()});}if(m){m.call(h||this,i[0]);}}});var d={};if(e){d["keys"]=c["keys"];if(c["shift"]){d["shift"]=false;}if(c["alt"]){d["alt"]=false;}if(c["ctrl"]){d["ctrl"]=false;}}this.onKeyUp(e?d:c,{fn:function(p,o){var i=Math.log(this._KEY_MARK[o[0]])/Math.log(2);this._holdBuffer&=~(1<<i);this._holdKeys.remove(o[0]);if(a){a.call(j||this,o[0]);}}});},_addKeyListener:function(e,f,g){if(!g){throw new TypeError();}var d=g["fn"],b=g["args"],c=g["scope"]||this;if(!d){throw new TypeError();}var a=new js.util.KeyListener(document,f,{"fn":d,"scope":b,"correctScope":c},e);a.enable();if(!this._keyListeners){this._keyListeners={};}this._keyListeners[js.lang.System.getUUID()]=a;},onKeyUp:function(a,b){this._addKeyListener("keyup",a,b);},onKeyDown:function(a,b){this._addKeyListener("keydown",a,b);},disableAllKeys:function(){for(k in this._keyListeners){var a=this._keyListeners[k];if(a){a.disable();}}},enableAllKeys:function(){for(k in this._keyListeners){var a=this._keyListeners[k];if(a){a.enable();}}},removeAllKeys:function(){this.disableAllKeys();this._keyListeners={};}};js.input.Mouse={LEFT:0,CENTER:1,RIGHT:2};js.input.MouseProvider=function(){};js.input.MouseProvider.prototype={_getCacheIndex4Mouse:function(h,j,g,f){var d=this._mouseCache;for(var e=0,c=d.length;e<c;e++){var b=d[e];if(b&&b["fn"]==g&&b["el"]==h&&b["type"]==j&&b["button"]==f){return e;}}return -1;},_cacheMouseFn:function(d,e,c,a,b){if(!this._mouseCache){this._mouseCache=[];}this._mouseCache.push({"fn":c,"type":e,"el":d,"button":b,"wfn":a});},_clearCacheItem4Mouse:function(a){delete this._mouseCache[a]["wfn"];delete this._mouseCache[a]["fn"];this._mouseCache.splice(a,1);},_fixMouseButton:function(a){if(js.lang.System.isUndefined(a)){a=0;}if(js.core.Env.ie){switch(a){case 1:return 4;case 2:return 2;default:return 1;}}return a;},onMouseShift:function(d,e,c,a,b){return js.core.Event.addListener(d,"mouse"+e,c,a,b||this);},onMouseTap:function(f,g,e,b,d,c){f=js.core.Dom.$(f);if(!f||!g||!e){return false;}c=this._fixMouseButton(c);var a=function(i,h){if(i.button==c){return e.call(this,i,h);}};this._cacheMouseFn(f,g,e,a,c);return js.core.Event.addListener(f,(g=="click"||g=="dblclick")?g:("mouse"+g),a,b,d||this);},onMouseLeftTap:function(d,e,c,a,b){return this.onMouseTap(d,e,c,a,b,0);},onMouseCenterTap:function(d,e,c,a,b){return this.onMouseTap(d,e,c,a,b,1);},onMouseRightTap:function(d,e,c,a,b){return this.onMouseTap(d,e,c,a,b,2);},rmMouseTap:function(d,e,c,b){d=js.core.Dom.$(d);if(!d||!e||!c){return false;}b=this._fixMouseButton(b);var a=this._getCacheIndex4Mouse(d,e,c,b);if(a==-1){return false;}var f=js.core.Event.removeListener(d,(e=="click"||e=="dblclick")?e:("mouse"+e),this._mouseCache[a]);this._clearCacheItem4Mouse(a);return f;},rmMouseLeftTap:function(c,d,b,a){return this.rmMouseTap(c,d,b,0);},rmMouseCenterTap:function(c,d,b,a){return this.rmMouseTap(c,d,b,1);},rmMouseRightTap:function(c,d,b,a){return this.rmMouseTap(c,d,b,2);}};