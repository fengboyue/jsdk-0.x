/*!
 * @project JSDK JavaScript Development Kit
 * @copyright Copyright(c) 2004-2012, Dragonfly.org. All rights reserved.
 * @license LGPLv3
 * 
 * @version 0.3
 * @author feng.chun
 * @date 2011-01-05
 * @date 2011-03-22
 * @date 2011-05-18
 * 
 * @version 0.2
 * @author feng.chun
 * @date 2010-11-15
 *
 * @version 0.1
 * @author feng.chun
 * @date 2010-9-20
 * 
 * @requires /core/js-core.js
 */
js.lang.System.namespace("js.d2");(function(){var a=js.lang.System,d=js.core.Dom,c=js.core.Dom.$,e=js.core.Env,b=js.core.Event;js.d2.Canvas=function(f){this._config={id:f["id"]||a.getUUID(),html:f["html"]||"",title:f["title"]||"",cssName:f["cssName"]||"",x:f["x"]||0,y:f["y"]||0,z:f["z"]||0,opacity:a.isUndefined(f["opacity"])?1:f["opacity"],width:f["width"]||0,height:f["height"]||0,background:f["background"]||""};this._config["viewWindow"]=f["viewWindow"]||this.getBound();this._init();};js.d2.Canvas.prototype={setViewWindow:function(l,k,n,j){var o=this.getViewWindow(),g=!a.isUndefined(l),f=!a.isUndefined(k),i=!a.isUndefined(n),m=!a.isUndefined(j);if(!g&&!f&&!i&&!m){return;}if(i){o["w"]=n;}if(m){o["h"]=j;}if(g){this._config["x"]+=o["x"]-l;o["x"]=l;}if(f){this._config["y"]+=o["y"]-k;o["y"]=k;}if(g||f){d.updateEl(this._config["id"],null,{left:(-o["x"])+"px",top:(-o["y"])+"px"});}if(i||m){d.updateEl(this._config["id"]+"_view_window",null,{width:o.w+"px",height:o.h+"px"});}},moveViewPoint:function(o,n,h){var m=this.getViewWindow(),l=m["x"]+o,k=m["y"]+n;if(h){var j=h["x"],g=h["x"]+h["w"]-m["w"],i=h["y"],f=h["y"]+h["h"]-m["h"];if(l<j){l=j;}else{if(l>g){l=g;}}if(k<i){k=i;}else{if(k>f){k=f;}}}this.setViewWindow(l,k);},getViewWindow:function(){return this._config["viewWindow"];},getConfig:function(f){return f?this._config[f]:this._config;},_setupView:function(){var f=this.getViewWindow(),g="left:"+this._config["x"]+"px;top:"+this._config["y"]+"px;z-index:"+this._config["z"]+";";g+="width:"+f["w"]+"px;height:"+f["h"]+"px;";g+="position:absolute;overflow:hidden;";this._config["x"]-=f["x"];this._config["y"]-=f["y"];return g?{cssText:g}:null;},_calcCanvasXY:function(){var f=this.getViewWindow();return[-f["x"],-f["y"]];},_setupCanvas:function(){var g=this._calcCanvasXY();var f="position:absolute;overflow:hidden;left:"+g[0]+"px;top:"+g[1]+"px;z-index:"+this._config["z"]+";";f+="width:"+this._config["width"]+"px;height:"+this._config["height"]+"px;";if(this._config["opacity"]<1){f+="filter:alpha(opacity:"+this._config["opacity"]*100+"); opacity:"+this._config["opacity"]+";";}f+="background:"+this._config["background"]+";";return f?{cssText:f}:null;},_init:function(){document.body.appendChild(d.createEl("div",{id:this._config["id"]+"_view_window",title:this._config["title"]},this._setupView()));c(this._config["id"]+"_view_window").appendChild(d.createEl("div",{id:this._config["id"],cssName:this._config["cssName"]},this._setupCanvas()));this._el=c(this._config["id"]);b.on(this._el,"contextmenu",function(f){b.stopEvent(f);});},hide:function(){var f=c(this._config["id"]+"_view_window");if(f){f.style.display="none";}},show:function(){var f=c(this._config["id"]+"_view_window");if(f){f.style.display="";}},getXY:function(){return[this._config["x"],this._config["y"]];},move:function(g,f){var h=this.getXY();if(!a.isUndefined(g)){h[0]+=g;}if(!a.isUndefined(f)){h[1]+=f;}this.setXY(h[0],h[1]);},setXY:function(f,h){var g=this.getViewWindow();if(!a.isUndefined(f)){this._config["x"]=f;d.setStyle(this._config["id"]+"_view_window","x",f);}if(!a.isUndefined(h)){this._config["y"]=h;d.setStyle(this._config["id"]+"_view_window","y",h);}},setSize:function(f,g){if(!a.isUndefined(f)){this._config["width"]=f;d.setStyle(this._config["id"],"width",f);}if(!a.isUndefined(g)){this._config["height"]=g;d.setStyle(this._config["id"],"height",g);}},getSize:function(){return[this._config["width"],this._config["height"]];},getBound:function(){return{x:0,y:0,w:this._config["width"],h:this._config["height"]};},getScreenBound:function(){return{x:this._config["x"],y:this._config["y"],w:this._config["width"],h:this._config["height"]};},_updateTextElement:function(f,g){d.setStyle(f,"opacity",a.isUndefined(g["opacity"])?1:g["opacity"]);d.setStyle(f,"visible",a.isUndefined(g["visible"])?true:g["visible"]);d.setStyle(f,"position","absolute");d.setStyle(f,"overflow","hidden");d.setStyle(f,"z",g["z"]);d.setStyle(f,"color",g["color"]);d.setStyle(f,"fontFamily",g["fontFamily"]);d.setStyle(f,"fontSize",g["fontSize"]);d.setStyle(f,"width",g["width"]);d.setStyle(f,"height",g["height"]);if(g["align"]=="center"){d.setStyle(f,"left","50%");d.setStyle(f,"marginLeft","-"+g["width"]/2+"px");}else{d.setStyle(f,"x",g["x"]);}if(g["valign"]=="middle"){d.setStyle(f,"top","50%");d.setStyle(f,"marginTop","-"+g["height"]/2+"px");}else{d.setStyle(f,"y",g["y"]);}d.setAttribute(f,"cssName",g["cssName"]);if(g["text"]){f.innerHTML=g["text"];}},drawText:function(g){if(!g){throw new TypeError("[js.d2.Canvas#drawText]The arguments is empty.");}var f=c(g["id"]);if(f){this._updateTextElement(f,g);}else{f=this.createText(g);this._el.appendChild(f);}return f;},createText:function(g){if(!g){throw new TypeError("[js.d2.Canvas#createText]The arguments is empty.");}var f=document.createElement("div");this._updateTextElement(f,g);d.setAttribute(f,"id",g["id"]||a.getUUID());return f;},updateText:function(g){if(!g){throw new TypeError("[js.d2.Canvas#updateText]The arguments is empty.");}var f=c(g["id"]);if(f){this._updateTextElement(f,g);}else{throw new Error("[js.d2.Canvas#updateText]Text's element not found.");}return f;},_updateImageElement:function(f,g){if(g["src"]){d.setStyle(f,"background","url("+g["src"]+") -"+(g["offsetX"]||0)+"px -"+(g["offsetY"]||0)+"px");}d.setStyle(f,"opacity",a.isUndefined(g["opacity"])?1:g["opacity"]);d.setStyle(f,"visible",a.isUndefined(g["visible"])?true:g["visible"]);d.setStyle(f,"position","absolute");d.setStyle(f,"overflow","hidden");d.setStyle(f,"x",g["x"]);d.setStyle(f,"y",g["y"]);d.setStyle(f,"z",g["z"]);d.setStyle(f,"width",g["width"]);d.setStyle(f,"height",g["height"]);d.setAttribute(f,"cssName",g["cssName"]);},drawImage:function(g){if(!g){throw new Error("[js.d2.Canvas#drawImage]The arguments is empty.");}var f=c(g["id"]);if(f){this._updateImageElement(f,g);}else{f=this.createImage(g);this._el.appendChild(f);}return f;},createImage:function(g){if(!g){throw new Error("[js.d2.Canvas#createImage]The arguments is empty.");}var f=document.createElement("div");this._updateImageElement(f,g);d.setAttribute(f,"id",g["id"]||a.getUUID());return f;},updateImage:function(g){if(!g){throw new Error("[js.d2.Canvas#updateImage]The arguments is empty.");}var f=c(g["id"]);if(f){this._updateImageElement(f,g);}else{throw new Error("[js.d2.Canvas#updateImage]Image's element not found.");}return f;},drawElement:function(f,g,j,h){if(!j){j={};}j["position"]="absolute";var i=d.createEl(f,g,j,h);this._el.appendChild(i);return i;},appendElement:function(f){if(f){this._el.appendChild(f);}},erase:function(g){var f=a.isArray(g)?g:[g];f.forEach(function(h){var i=c(h);if(i){b.purgeElement(i,true);this._el.removeChild(i);}},this);},destory:function(){if(this._el&&this._el.parentNode){b.purgeElement(this._el,true);this._el.parentNode.removeChild(this._el);}},clear:function(){b.purgeElement(this._el,true);var f=this._el.childNodes;if(!f){return;}while(f.length>0){var g=this._el.childNodes[0];this._el.removeChild(g);}},printFPS:function(f){this.drawText({id:"fps",text:"FPS="+f,z:99,x:this.getConfig("width")-100,y:0,color:"yellow",fontSize:"18px"});}};js.d2.View=function(f){this._id=f["id"]||a.getUUID();this._x=a.isUndefined(f["x"])?0:f["x"];this._y=a.isUndefined(f["y"])?0:f["y"];this._z=a.isUndefined(f["z"])?0:f["z"];this._w=a.isUndefined(f["width"])?0:f["width"];this._h=a.isUndefined(f["height"])?0:f["height"];this._isV=a.isUndefined(f["visible"])?true:f["visible"];this._isD=false;this._isM=a.isUndefined(f["movable"])?true:f["movable"];this._opacity=a.isUndefined(f["opacity"])?1:f["opacity"];this.createEvent("painting");this.createEvent("painted");this.createEvent("destorying",true);this.createEvent("destoryed",true);this.createEvent("moving");this.createEvent("moved");};js.d2.View.prototype={getId:function(){return this._id;},getBound:function(){return{x:this._x,y:this._y,w:this._w,h:this._h};},getScreenBound:function(){var f=d.getXY(this._id);if(f){return{x:f[0],y:f[1],w:this._w,h:this._h};}return null;},getWidth:function(){return this._w;},getHeight:function(){return this._h;},getSize:function(){return[this._w,this._h];},setSize:function(f,g){this._w=f;this._h=g;},getX:function(){return this._x;},getY:function(){return this._y;},getZ:function(){return this._z;},setX:function(f){if(!this.isMovable()){return;}this._x=f;},setY:function(f){if(!this.isMovable()){return;}this._y=f;},setZ:function(f){if(!this.isMovable()){return;}this._z=f;},setXY:function(f,g){if(!this.isMovable()){return;}this._x=f;this._y=g;},getXY:function(){return[this._x,this._y];},isMovable:function(){return this._isM;},setMovable:function(f){this._isM=f;},setOpacity:function(f){this._opacity=f;},getOpacity:function(){return this._opacity;},move:function(g,f){if(!this.isMovable()){return;}var h=[Number(this._x),Number(this._y)];this.fireEvent("moving",h);this._x+=g;this._y+=f;this.fireEvent("moved",h,[this._x,this._y]);},isVisible:function(){return this._isV;},setVisible:function(f){this._isV=f;},isDestoryed:function(){return this._isD;},destory:function(f){this.fireEvent("destorying");f.erase(this.getId());this._isV=false;this._isD=true;this.fireEvent("destoryed");this.unsubscribeAll();},paint:function(f){}};a.augment(js.d2.View,js.core.EventProvider);}());