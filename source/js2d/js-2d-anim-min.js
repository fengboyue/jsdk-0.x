/*!
 * @project JSDK JavaScript Development Kit
 * @copyright Copyright(c) 2004-2012, Dragonfly.org. All rights reserved.
 * @license LGPLv3
 * 
 * @version 0.3
 * @author feng.chun
 * @date 2011-01-05
 * @date 2011-01-11
 * @date 2011-03-22
 * 
 * @version 0.2
 * @author feng.chun
 * @date 2010-12-31
 * 
 * @version 0.1
 * @author feng.chun
 * @date 2010-10-6
 * 
 * @requires /core/js-core.js
 * @requires /core/js-mathphys.js
 */
js.lang.System.namespace("js.anim");(function(){var c=js.lang.System,e=js.core.Dom,d=js.core.Dom.$,b=js.math.MathTool,a=js.math.Geom2D;js.anim.Formulas={linear:function(g,f,i,h){return i*g/h+f;},quad_easein:function(g,f,i,h){return i*(g/=h)*g+f;},quad_easeout:function(g,f,i,h){return -i*(g/=h)*(g-2)+f;},quad_easeinout:function(g,f,i,h){if((g/=h/2)<1){return i/2*g*g+f;}return -i/2*((--g)*(g-2)-1)+f;},cubic_easein:function(g,f,i,h){return i*(g/=h)*g*g+f;},cubic_easeout:function(g,f,i,h){return i*((g=g/h-1)*g*g+1)+f;},cubic_easeinout:function(g,f,i,h){if((g/=h/2)<1){return i/2*g*g*g+f;}return i/2*((g-=2)*g*g+2)+f;},quart_easein:function(g,f,i,h){return i*(g/=h)*g*g*g+f;},quart_easeout:function(g,f,i,h){return -i*((g=g/h-1)*g*g*g-1)+f;},quart_easeinout:function(g,f,i,h){if((g/=h/2)<1){return i/2*g*g*g*g+f;}return -i/2*((g-=2)*g*g*g-2)+f;},quint_easein:function(g,f,i,h){return i*(g/=h)*g*g*g*g+f;},quint_easeout:function(g,f,i,h){return i*((g=g/h-1)*g*g*g*g+1)+f;},quint_easeinout:function(g,f,i,h){if((g/=h/2)<1){return i/2*g*g*g*g*g+f;}return i/2*((g-=2)*g*g*g*g+2)+f;},sine_easein:function(g,f,i,h){return -i*Math.cos(g/h*(Math.PI/2))+i+f;},sine_easeout:function(g,f,i,h){return i*Math.sin(g/h*(Math.PI/2))+f;},sine_easeinout:function(g,f,i,h){return -i/2*(Math.cos(Math.PI*g/h)-1)+f;},expo_easein:function(g,f,i,h){return(g==0)?f:i*Math.pow(2,10*(g/h-1))+f;},expo_easeout:function(g,f,i,h){return(g==h)?f+i:i*(-Math.pow(2,-10*g/h)+1)+f;},expo_easeinout:function(g,f,i,h){if(g==0){return f;}if(g==h){return f+i;}if((g/=h/2)<1){return i/2*Math.pow(2,10*(g-1))+f;}return i/2*(-Math.pow(2,-10*--g)+2)+f;},circ_easein:function(g,f,i,h){return -i*(Math.sqrt(1-(g/=h)*g)-1)+f;},circ_easeout:function(g,f,i,h){return i*Math.sqrt(1-(g=g/h-1)*g)+f;},circ_easeinout:function(g,f,i,h){if((g/=h/2)<1){return -i/2*(Math.sqrt(1-g*g)-1)+f;}return i/2*(Math.sqrt(1-(g-=2)*g)+1)+f;},elastic_easein:function(h,f,l,k,g,j){if(h==0){return f;}if((h/=k)==1){return f+l;}if(!j){j=k*0.3;}if(!g||g<Math.abs(l)){g=l;var i=j/4;}else{var i=j/(2*Math.PI)*Math.asin(l/g);}return -(g*Math.pow(2,10*(h-=1))*Math.sin((h*k-i)*(2*Math.PI)/j))+f;},elastic_easeout:function(h,f,l,k,g,j){if(h==0){return f;}if((h/=k)==1){return f+l;}if(!j){j=k*0.3;}if(!g||g<Math.abs(l)){g=l;var i=j/4;}else{var i=j/(2*Math.PI)*Math.asin(l/g);}return(g*Math.pow(2,-10*h)*Math.sin((h*k-i)*(2*Math.PI)/j)+l+f);},elastic_easeinout:function(h,f,l,k,g,j){if(h==0){return f;}if((h/=k/2)==2){return f+l;}if(!j){j=k*(0.3*1.5);}if(!g||g<Math.abs(l)){g=l;var i=j/4;}else{var i=j/(2*Math.PI)*Math.asin(l/g);}if(h<1){return -0.5*(g*Math.pow(2,10*(h-=1))*Math.sin((h*k-i)*(2*Math.PI)/j))+f;}return g*Math.pow(2,-10*(h-=1))*Math.sin((h*k-i)*(2*Math.PI)/j)*0.5+l+f;},back_easein:function(g,f,j,i,h){if(h==undefined){h=1.70158;}return j*(g/=i)*g*((h+1)*g-h)+f;},back_easeout:function(g,f,j,i,h){if(h==undefined){h=1.70158;}return j*((g=g/i-1)*g*((h+1)*g+h)+1)+f;},back_easeinout:function(g,f,j,i,h){if(h==undefined){h=1.70158;}if((g/=i/2)<1){return j/2*(g*g*(((h*=(1.525))+1)*g-h))+f;}return j/2*((g-=2)*g*(((h*=(1.525))+1)*g+h)+2)+f;},bounce_easein:function(g,f,i,h){return i-this.bounce_easeout(h-g,0,i,h)+f;},bounce_easeout:function(g,f,i,h){if((g/=h)<(1/2.75)){return i*(7.5625*g*g)+f;}else{if(g<(2/2.75)){return i*(7.5625*(g-=(1.5/2.75))*g+0.75)+f;}else{if(g<(2.5/2.75)){return i*(7.5625*(g-=(2.25/2.75))*g+0.9375)+f;}else{return i*(7.5625*(g-=(2.625/2.75))*g+0.984375)+f;}}}},bounce_easeinout:function(g,f,i,h){if(g<h/2){return this.bounce_easein(g*2,0,i,h)*0.5+f;}else{return this.bounce_easeout(g*2-h,0,i,h)*0.5+i*0.5+f;}}};js.anim.Anim=function(f,g){this._config=f;this._method=g;this._isAnimated=false;this._startTime=null;this._counter=0;this._maxRepeat=f["repeat"]||0;this._repeat=0;this.createEvent("started");this.createEvent("completed");this.createEvent("stoped");this.createEvent("looped");this.createEvent("repeated");this._thread=new c.Thread(this,{interval:this._config["interval"]});};js.anim.Anim.prototype={setConfig:function(g,f){this._config[g]=f;},getConfig:function(f){return this._config[f];},getMaxTimes:function(){return this._maxRepeat;},getCurrentTimes:function(){return this._repeat;},getCount:function(){return this._counter;},isAnimated:function(){return this._isAnimated;},getStartTime:function(){return this._startTime;},start:function(){if(this.isAnimated()){return;}this._isAnimated=true;this._counter=0;this._repeat=0;this._startTime=new Date();this._thread.start();this.fireEvent("started");},resetCount:function(){this._counter=0;},run:function(){if(typeof this._method=="function"){var f=this._method.call(this,this._counter,this._repeat);this._counter++;this.fireEvent("looped",this._counter,this._repeat);if(f){this._counter=0;if((this._repeat+1)>this._maxRepeat){this.complete();}else{this._repeat++;this.fireEvent("repeated");}}}else{this.complete();}},complete:function(){if(!this.isAnimated()){return;}this._thread.stop();this._counter=0;this._isAnimated=false;this.fireEvent("completed");},stop:function(){if(!this.isAnimated()){return;}this._thread.stop();this._counter=0;this._isAnimated=false;this.fireEvent("stoped");}};c.augment(js.anim.Anim,js.core.EventProvider);js.anim.Film=function(h){var i=h["width"],k=h["height"],j=h["canvas"],g=h["frameSeq"],l=h["src"];if(!j||!g||!l){throw new TypeError("[js.anim.Film]The arguments invalid.");}this._objArray=c.isString(h["target"])?[{"id":h["target"]}]:(h["target"]||[]);var f=function(m){if(m>=g.length){this._objArray.forEach(function(n){j.erase(n["id"]);});return true;}this._objArray.forEach(function(n){if(c.isUndefined(n["id"])){n["id"]=c.getUUID();}var p=g[m],o={id:n["id"],z:n["z"]||0,width:i,height:k,src:l,x:n["x"]||0,y:n["y"]||0,offsetX:p[0],offsetY:p[1]};if(d(n["id"])){j.updateImage(o);}else{j.drawImage(o);}},this);return false;};js.anim.Film.superclass.constructor.call(this,h,f);};c.extend(js.anim.Film,js.anim.Anim,{setPosition:function(f,h){var g=this._objArray.indexOf(h,function(j,i){return j["id"]===i;});if(g>-1){this._objArray[g]={id:h,x:f[0],y:f[1],z:f[2]};}else{this._objArray.push({id:h,x:f[0],y:f[1],z:f[2]});}}});js.anim.Motion=function(g){var k=g["target"],i=g["points"],m=i["to"];if(!k||!i||!m){throw new TypeError("[js.anim.Motion]The arguments invalid.");}this._formula=g["formula"]||js.anim.Formulas.linear;var l=[i["from"]||e.getXY(k)],j=i["path"];if(j){l=l.concat(j);}l.push(m);this._ps=l;this._psIndex=0;var h=function(o,n,p){e.setStyle(o,"x",n);e.setStyle(o,"y",p);};var f=function(o){var q=this.getConfig("target"),p=this.getConfig("step")||1,u=this._ps[this._psIndex],s=this._ps[this._psIndex+1];var n=this._formula(o,u[0],s[0]-u[0],p),r=this._formula(o,u[1],s[1]-u[1],p);h(q,n,r);if(a.equalsPoint([n,r],this._ps[this._ps.length-1])){this._psIndex=0;return true;}if(a.equalsPoint(s,[n,r])){this._psIndex+=1;this.resetCount();}return false;};js.anim.Motion.superclass.constructor.call(this,g,f);};c.extend(js.anim.Motion,js.anim.Anim,{});js.anim.Flicker=function(h){var i=h["target"],f=h["opacity"];if(!i||!f){throw new TypeError("[js.anim.Flicker]The arguments invalid.");}this._from=f["from"];this._to=f["to"];if(c.isUndefined(this._from)||c.isUndefined(this._to)){throw new TypeError("[js.anim.Flicker]The arguments invalid.");}var g=function(k){var l=this.getConfig("step")||1,m=this.getConfig("target"),o=this._from,n=this._to;var j=o+k*(n-o)/l;e.setStyle(m,"opacity",j);if(b.equals(j,n)){return true;}};js.anim.Flicker.superclass.constructor.call(this,h,g);};c.extend(js.anim.Flicker,js.anim.Anim,{start:function(){if(!this.isAnimated()){this._from=c.isUndefined(this._from)?Number(e.getStyle(this.getConfig("target"),"opacity")):this._from;}js.anim.Motion.superclass.start.call(this);}});}());