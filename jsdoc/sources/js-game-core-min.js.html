<!--  -->
<HTML>
<HEAD>
<TITLE></TITLE>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<LINK REL ="stylesheet" TYPE="text/css" HREF="../inc/stylesheet.css">
</HEAD>

<BODY style="margin:5px;">
<div style="float:right;">
<span class="button" onclick="if(window.history.length > 1) window.history.go(-1);">Back</span>
</div>
<div style="margin-left:5px;">jsgf\js-game-core-min.js</div>
<pre class="source">
<span class="multiComment">/*!
 * @project JSDK JavaScript Development Kit
 * @copyright Copyright(c) 2004-2012, Dragonfly.org. All rights reserved.
 * @license LGPLv3
 * 
 * @version 0.2
 * @author feng.chun
 * @date 2010-11-15
 * @date 2011-04-14
 * @date 2011-10-19
 * 
 * @version 0.1
 * @author feng.chun
 * @date 2010-10-6
 * 
 * @requires /core/js-core.js
 * @requires /core/js-mathphys.js
 * @requires /core/js-thread.js
 * @requires /core/js-input.js
 * @requires /js2d/js-2d-core.js
 */</span>
js.lang.System.namespace("js.game.collision");(<b>function </b>(){<b>var </b>c=js.lang.System,f=js.core.Dom,e=js.core.Dom.$,d=js.core.Event,b=js.math.MathTool,a=js.math.Geom2D;js.game.Sprite=<b>function </b>(g){js.game.Sprite.superclass.constructor.apply(<b>this</b>,arguments);<b>this</b>._dir=g["dir"]||b.RADIAN_0;<b>this</b>._imageSrc=g["imageSrc"];<b>this</b>._frameSeqs=g["frameSeqs"];<b>this</b>._frameKey=g["frameSeqKey"];<b>this</b>._frameIndex=0;<b>this</b>._aabbs={};<b>this</b>.createEvent("turning");<b>this</b>.createEvent("turned");};c.extend(js.game.Sprite,js.d2.View,{getImageSrc:<b>function </b>(){<b>return</b> <b>this</b>._imageSrc;},paint:<b>function </b>(g){<b>if </b>(<b>this</b>._isD){<b>return</b>;}<b>this</b>.fireEvent("painting");g.drawImage(<b>this</b>.getFrame());<b>this</b>.fireEvent("painted");},getFrame:<b>function </b>(){<b>var </b>h=c.isUndefined(arguments[0])?<b>this</b>._frameIndex:arguments[0],g=arguments[1]||<b>this</b>._frameKey;<b>var </b>k=<b>this</b>._frameSeqs[g];<b>if </b>(!k){<b>throw </b><b>new </b>Error();}<b>var </b>j=k[h];<b>if </b>(!j){<b>throw </b><b>new </b>Error();}<b>if </b>(!<b>this</b>._isV){<b>return</b>{id:<b>this</b>._id,visible:<b>false</b>};}<b>else </b>{<b>return</b>{id:<b>this</b>._id,x:<b>this</b>._x,y:<b>this</b>._y,z:<b>this</b>._z,opacity:<b>this</b>._opacity,src:<b>this</b>._imageSrc,offsetX:j[0],offsetY:j[1],width:<b>this</b>._w,height:<b>this</b>._h,visible:<b>true</b>};}},setFrameIndex:<b>function </b>(g){<b>if </b>(g<b> in </b><b>this</b>._frameSeqs[<b>this</b>._frameKey]){<b>this</b>._frameIndex=g;}<b>else </b>{<b>this</b>._frameIndex=0;}},setFrameSeqKey:<b>function </b>(g){<b>if </b>(g<b> in </b><b>this</b>._frameSeqs){<b>this</b>._frameKey=g;}},getFrameSeqKey:<b>function </b>(){<b>return</b> <b>this</b>._frameKey;},nextFrame:<b>function </b>(){<b>var </b>g=<b>this</b>._frameSeqs[<b>this</b>._frameKey];<b>if </b>(!g){<b>throw </b><b>new </b>Error();}<b>this</b>._frameIndex=<b>this</b>._frameIndex&gt;=(g.length-1)?0:<b>this</b>._frameIndex+1;},prevFrame:<b>function </b>(){<b>var </b>g=<b>this</b>._frameSeqs[<b>this</b>._frameKey];<b>if </b>(!g){<b>throw </b><b>new </b>Error();}<b>this</b>._frameIndex=<b>this</b>._frameIndex&lt;=0?g.length-1:<b>this</b>._frameIndex-1;},getFrameSeq:<b>function </b>(g){<b>return</b> g?<b>this</b>._frameSeqs[g]:<b>this</b>._frameSeqs;},setFrameSeq:<b>function </b>(g,h){<b>return</b> <b>this</b>._frameSeqs[g]=h;},getDir:<b>function </b>(){<b>return</b> <b>this</b>._dir;},turn:<b>function </b>(g){<b>if </b>(c.isUndefined(g)){<b>return</b>;}<b>this</b>.fireEvent("turning",g);<b>this</b>._dir=g;<b>this</b>.fireEvent("turned",g);},moveWith:<b>function </b>(g){<b>var </b>h=b.polar2XY(g,<b>this</b>.getDir());<b>this</b>.move(h[0],h[1]);},setAABB:<b>function </b>(g,h){<b>this</b>._aabbs[g]=<b>new </b>js.game.collision.AABB(<b>this</b>,h);},getAABB:<b>function </b>(g){<b>return</b> <b>this</b>._aabbs[g];}});js.game.TiledLayer=<b>function </b>(g){js.game.TiledLayer.superclass.constructor.apply(<b>this</b>,arguments);<b>this</b>._src=g["src"];<b>this</b>._cellSize=g["cell_size"];<b>this</b>._tileSet=g["tile_set"];<b>this</b>._data=<b>null</b>;<b>this</b>._paintRect=<b>null</b>;<b>this</b>.createEvent("painted");};c.extend(js.game.TiledLayer,js.d2.View,{_check:<b>function </b>(h,j,g){<b>if </b>(!g||g.length&lt;1||isNaN(h)||isNaN(j)){<b>return</b> <b>false</b>;}<b>var </b>i=[g[0].length,g.length];<b>return</b>(h&lt;0||h&gt;=i[0]||j&lt;0||j&gt;=i[1])?<b>false</b>:<b>true</b>;},_getCellId:<b>function </b>(h,g){<b>return</b> <b>this</b>.getId()+"_"+h+"_"+g;},_getImage:<b>function </b>(j,i,m){<b>var </b>l=<b>this</b>._tileSet?<b>this</b>._tileSet[m]:String(m).split(","),g=<b>this</b>._cellSize[0],k=<b>this</b>._cellSize[1];<b>return</b>{id:<b>this</b>._getCellId(j,i),src:<b>this</b>._src,width:g,height:k,offsetX:l[0],offsetY:l[1],x:<b>this</b>._x+g*j,y:<b>this</b>._y+k*i};},paint:<b>function </b>(h){<b>if </b>(!<b>this</b>.isVisible()||!<b>this</b>._data){<b>return</b>;}<b>var </b>r=a.intersectsRect(<b>this</b>.getPaintRect(),{x:0,y:0,w:<b>this</b>._data[0].length,h:<b>this</b>._data.length});<b>if </b>(!r){<b>return</b>;}<b>var </b>t=r.x,s=r.y,u=r.w,p=r.h;<b>var </b>q=e(<b>this</b>.getId());<b>if </b>(!q){q=h.drawElement("div",{id:<b>this</b>.getId()});}<b>var </b>v=document.createDocumentFragment();<b>for </b>(<b>var </b>o=s,n=s+p;o&lt;n;o++){<b>for </b>(<b>var </b>m=t,l=t+u;m&lt;l;m++){<b>var </b>k=<b>this</b>.getCell(m,o);<b>var </b>g=h.createImage(<b>this</b>._getImage(m,o,k));g.setAttribute("jsdk_jsgf_tileIndex",k);v.appendChild(g);<b>this</b>.fireEvent("painted",g,k,[m,o]);}}q.appendChild(v);},getCellBound:<b>function </b>(i,h){<b>var </b>j=<b>this</b>._cellSize[0],g=<b>this</b>._cellSize[1];<b>return</b>{x:<b>this</b>._x+i*j,y:<b>this</b>._y+h*g,w:j,h:g};},getCellSize:<b>function </b>(){<b>return</b> <b>this</b>._cellSize;},getCell:<b>function </b>(i,h){<b>if </b>(!<b>this</b>._check(i,h,<b>this</b>._data)){<b>var </b>g=e(<b>this</b>._getCellId(i,h));<b>if </b>(g){<b>return</b> g.getAttribute("jsdk_jsgf_tileIndex");}<b>else </b>{<b>return</b> <b>null</b>;}}<b>return</b> <b>this</b>._data[h][i];},isVisibleCell:<b>function </b>(i,h){<b>var </b>g=e(<b>this</b>._getCellId(i,h));<b>return</b> g?<b>true</b>:<b>false</b>;},setCell:<b>function </b>(h,g,i){<b>if </b>(!<b>this</b>._check(h,g,<b>this</b>._data)){<b>throw </b><b>new </b>Error();}<b>this</b>._data[g][h]=i;},fillCells:<b>function </b>(k,g,o,n,m){<b>if </b>(!<b>this</b>._check(k+o,g+n,<b>this</b>._data)){<b>throw </b><b>new </b>Error();}<b>for </b>(<b>var </b>l=k;l&lt;o;l++){<b>for </b>(<b>var </b>h=g;l&lt;n;l++){<b>this</b>.setCell(l,h,m);}}},getPaintRect:<b>function </b>(){<b>if </b>(!<b>this</b>._paintRect){<b>this</b>._paintRect={x:0,y:0,w:<b>this</b>._w,h:<b>this</b>._h};}<b>return</b> <b>this</b>._paintRect;},_setNumber:<b>function </b>(h,j,i,g){<b>if </b>(!c.isUndefined(j)){<b>this</b>._paintRect[h]=j;}},setPaintRect:<b>function </b>(h,g,k,j){<b>if </b>(!<b>this</b>._paintRect){<b>this</b>._paintRect={x:0,y:0,w:<b>this</b>._w,h:<b>this</b>._h};}<b>var </b>i=<b>this</b>.getSize();<b>this</b>._setNumber("x",h);<b>this</b>._setNumber("y",g);<b>this</b>._setNumber("w",k);<b>this</b>._setNumber("h",j);},movePaintRect:<b>function </b>(h,g){<b>var </b>i=<b>this</b>.getPaintRect();<b>this</b>.setPaintRect(i.x+h,i.y+g);},setData:<b>function </b>(g){<b>if </b>(!g||g.length&lt;1||c.isUndefined(g[0][0])){<b>this</b>._data=<b>null</b>;<b>this</b>.setSize(0,0);}<b>else </b>{<b>this</b>._data=g;<b>this</b>.setSize(g[0].length,g.length);}},getData:<b>function </b>(){<b>return</b> <b>this</b>._data;},getCellXY:<b>function </b>(g,j){<b>var </b>i=Math.floor((g-<b>this</b>._x)/<b>this</b>._cellSize[0]),h=Math.floor((j-<b>this</b>._y)/<b>this</b>._cellSize[1]);<b>return</b>[i,h];},getCellByXY:<b>function </b>(g,i){<b>var </b>h=<b>this</b>.getCellXY(g,i);<b>return</b> <b>this</b>.getCell(h[0],h[1]);}});c.augment(js.game.TiledLayer,js.core.EventProvider);js.game.collision.AABB=<b>function </b>(g,h){<b>this</b>.sprite=g;<b>this</b>.collisionRect=h?h:{x:0,y:0,w:g.getWidth(),h:g.getHeight()};};js.game.collision.AABB.prototype={getBoundingBox:<b>function </b>(){<b>var </b>g=<b>this</b>.sprite.getBound();<b>return</b>{x:g.x+<b>this</b>.collisionRect.x,y:g.y+<b>this</b>.collisionRect.y,w:<b>this</b>.collisionRect.w,h:<b>this</b>.collisionRect.h};},isDestoryed:<b>function </b>(){<b>return</b> <b>this</b>.sprite.isDestoryed();},collidesWith:<b>function </b>(g){<b>if </b>(!g||<b>this</b>.isDestoryed()||(g.isDestoryed&&g.isDestoryed())){<b>return</b> <b>false</b>;}<b>var </b>h=(g<b> instanceof </b>js.game.collision.AABB)?g.getBoundingBox():g;<b>return</b> a.intersectsRect(<b>this</b>.getBoundingBox(),h)!=<b>null</b>;},collidesWithTiles:<b>function </b>(h,j){<b>if </b>(!h||!j||<b>this</b>.isDestoryed()||h.isDestoryed()){<b>return</b> <b>false</b>;}<b>var </b>k=<b>this</b>.getBoundingBox(),g=<b>this</b>.sprite.getDir(),i=a.getRectPoints(k);<b>return</b> i.some(<b>function </b>(o,n){<b>var </b>m=h.getCellXY(o[0],o[1]);<b>if </b>(!h.isVisibleCell(m[0],m[1])){<b>return</b> <b>false</b>;}<b>var </b>l=h.getCell(m[0],m[1]);<b>return</b> !c.isUndefined(l)&&j.indexOf(l)&gt;=0;},<b>this</b>);},a<b>void</b>To:<b>function </b>(h){<b>if </b>(!(h<b> instanceof </b>js.game.collision.AABB)||h.isDestoryed()){<b>return</b> <b>false</b>;}<b>var </b>g=a.a<b>void</b>ToRect(<b>this</b>.getBoundingBox(),h.getBoundingBox(),<b>this</b>.sprite.getDir());<b>if </b>(g){<b>this</b>.sprite.setXY(g[0]-<b>this</b>.collisionRect.x,g[1]-<b>this</b>.collisionRect.y);<b>return</b> <b>true</b>;}<b>return</b> <b>false</b>;},a<b>void</b>ToTiles:<b>function </b>(h,j){<b>if </b>(!h||!j||<b>this</b>.isDestoryed()||h.isDestoryed()){<b>return</b> <b>false</b>;}<b>var </b>k=<b>this</b>.getBoundingBox(),g=<b>this</b>.sprite.getDir(),i=a.getRectPoints(k);<b>return</b> i.some(<b>function </b>(q,o){<b>var </b>n=h.getCellXY(q[0],q[1]);<b>if </b>(!h.isVisibleCell(n[0],n[1])){<b>return</b> <b>false</b>;}<b>var </b>m=h.getCell(n[0],n[1]);<b>if </b>(c.isUndefined(m)||j.indexOf(m)&lt;0){<b>return</b> <b>false</b>;}<b>var </b>l=a.a<b>void</b>ToRect(k,h.getCellBound(n[0],n[1]),g);<b>if </b>(l){<b>this</b>.sprite.setXY(l[0]-<b>this</b>.collisionRect.x,l[1]-<b>this</b>.collisionRect.y);<b>return</b> <b>true</b>;}},<b>this</b>);},limitIn:<b>function </b>(g){<b>if </b>(!g||<b>this</b>.isDestoryed()){<b>return</b> <b>false</b>;}<b>var </b>h=<b>this</b>.getBoundingBox();<b>if </b>(a.limitInRect(h,g)){<b>this</b>.sprite.setXY(h.x-<b>this</b>.collisionRect.x,h.y-<b>this</b>.collisionRect.y);<b>return</b> <b>true</b>;}<b>return</b> <b>false</b>;},isInBox:<b>function </b>(h){<b>if </b>(!h||<b>this</b>.isDestoryed()||(h.isDestoryed&&h.isDestoryed())){<b>return</b> <b>false</b>;}<b>var </b>i=<b>this</b>.getBoundingBox(),g=(h<b> instanceof </b>js.game.collision.AABB)?h.getBoundingBox():h;<b>return</b> a.containsRect(g,i);}};js.game.GameStatus={UNSTART:-1,RUNNING:1,PAUSED:2,ENDED:3};js.game.Game=<b>function </b>(g){<b>this</b>._id=g["id"]||c.getUUID();<b>this</b>._status=js.game.GameStatus.UNSTART;<b>this</b>._config=g;<b>this</b>.createEvent("starting");<b>this</b>.createEvent("started");<b>this</b>.createEvent("resuming");<b>this</b>.createEvent("resumed");<b>this</b>.createEvent("pausing");<b>this</b>.createEvent("paused");<b>this</b>.createEvent("ending");<b>this</b>.createEvent("ended");<b>this</b>._initCanvas();};js.game.Game.prototype={_initCanvas:<b>function </b>(){<b>if </b>(e(<b>this</b>.getId()+"_canvas")){<b>return</b>;}<b>this</b>._canvas=<b>new </b>js.d2.Canvas({id:<b>this</b>.getId()+"_canvas",background:<b>this</b>._config["background"],viewWindow:<b>this</b>._config["viewWindow"],x:<b>this</b>._config["x"],y:<b>this</b>._config["y"],width:<b>this</b>._config["width"],height:<b>this</b>._config["height"]});},getThread:<b>function </b>(){<b>return</b> <b>this</b>._thread;},getConfig:<b>function </b>(g){<b>return</b> c.isUndefined(g)?<b>this</b>._config:<b>this</b>._config[g];},watchFPS:<b>function </b>(g){<b>var </b>h={};<b>if </b>(c.isBoolean(g)){<b>if </b>(g){h["scope"]=<b>this</b>._canvas;h["fn"]=<b>function </b>(i){<b>this</b>.printFPS(i);};}<b>else </b>{h=<b>null</b>;}}<b>else </b>{h["scope"]=g||<b>this</b>._canvas;h["fn"]=<b>function </b>(i){<b>this</b>.printFPS(i);};}<b>this</b>._config["fpsCallback"]=h;<b>if </b>(<b>this</b>._thread!=<b>null</b>){<b>this</b>._thread.setFPSCallback(h);}},getId:<b>function </b>(){<b>return</b> <b>this</b>._id;},getCanvas:<b>function </b>(){<b>return</b> <b>this</b>._canvas;},getStatus:<b>function </b>(){<b>return</b> <b>this</b>._status;},isRunning:<b>function </b>(){<b>return</b> <b>this</b>.getStatus()==js.game.GameStatus.RUNNING;},isPaused:<b>function </b>(){<b>return</b> <b>this</b>.getStatus()==js.game.GameStatus.PAUSED;},isEnded:<b>function </b>(){<b>return</b> <b>this</b>.getStatus()==js.game.GameStatus.ENDED;},start:<b>function </b>(){<b>this</b>._initCanvas();<b>this</b>.fireEvent("starting");<b>this</b>._thread=<b>new </b>c.Thread(<b>this</b>,{interval:<b>this</b>._config["interval"],fpsMax:<b>this</b>._config["fpsMax"]});<b>this</b>._thread.setFPSCallback(<b>this</b>._config["fpsCallback"]);<b>this</b>._thread.start();<b>this</b>._status=js.game.GameStatus.RUNNING;<b>this</b>.fireEvent("started");},resume:<b>function </b>(){<b>this</b>.fireEvent("resuming");<b>this</b>._status=js.game.GameStatus.RUNNING;<b>this</b>._thread.resume();<b>this</b>.fireEvent("resumed");},pause:<b>function </b>(){<b>this</b>.fireEvent("pausing");<b>this</b>._status=js.game.GameStatus.PAUSED;<b>this</b>._thread.suspend();<b>this</b>.fireEvent("paused");},end:<b>function </b>(){<b>this</b>.fireEvent("ending");<b>this</b>._status=js.game.GameStatus.ENDED;<b>this</b>._thread.stop();<b>this</b>._thread=<b>null</b>;<b>this</b>.fireEvent("ended");},run:<b>function </b>(){}};c.augment(js.game.Game,js.core.EventProvider);c.augment(js.game.Game,js.input.KeyBufferProvider);c.augment(js.game.Game,js.input.MouseProvider);js.game.Mission=<b>function </b>(g){<b>this</b>._config=g;<b>this</b>._s=<b>false</b>;<b>this</b>.createEvent("starting");<b>this</b>.createEvent("started");<b>this</b>.createEvent("running");<b>this</b>.createEvent("completed");<b>this</b>.createEvent("failed");};js.game.Mission.prototype={getConfig:<b>function </b>(g){<b>return</b> g?<b>this</b>._config[g]:<b>this</b>._config;},isStarted:<b>function </b>(){<b>return</b> <b>this</b>._s;},setStarted:<b>function </b>(g){<b>return</b> <b>this</b>._s=g;},start:<b>function </b>(g){},run:<b>function </b>(g){},fail:<b>function </b>(){<b>this</b>._s=<b>false</b>;<b>this</b>.fireEvent("failed");},complete:<b>function </b>(){<b>this</b>._s=<b>false</b>;<b>this</b>.fireEvent("completed");}};c.augment(js.game.Mission,js.core.EventProvider);js.game.MissionManager=<b>function </b>(){<b>this</b>._missions=[];<b>this</b>._missionIndex=-1;<b>this</b>._onMission={};};js.game.MissionManager.prototype={_subscribeMission:<b>function </b>(i,h){<b>if </b>(!<b>this</b>._onMission){<b>return</b>;}<b>var </b>g=<b>this</b>._onMission[h];<b>if </b>(g){i.subscribe(h,g);}},_unsubscribeMission:<b>function </b>(i,h){<b>if </b>(!<b>this</b>._onMission){<b>return</b>;}<b>var </b>g=<b>this</b>._onMission[h];<b>if </b>(g){i.unsubscribe(h,g);}},_loadMission:<b>function </b>(g){<b>if </b>(g){<b>this</b>._subscribeMission(g,"starting");<b>this</b>._subscribeMission(g,"started");<b>this</b>._subscribeMission(g,"running");<b>this</b>._subscribeMission(g,"completed");<b>this</b>._subscribeMission(g,"failed");<b>this</b>._missions.push(g);}},loadMissions:<b>function </b>(g){<b>if </b>(!c.isArray(g)){<b>this</b>._loadMission(g);}<b>else </b>{g.forEach(<b>function </b>(h){<b>this</b>._loadMission(h);},<b>this</b>);}},_unloadMission:<b>function </b>(h){<b>var </b>g=<b>this</b>._missions[h];<b>if </b>(!g){<b>return</b>;}<b>this</b>._unsubscribeMission(g,"starting");<b>this</b>._unsubscribeMission(g,"started");<b>this</b>._unsubscribeMission(g,"running");<b>this</b>._unsubscribeMission(g,"completed");<b>this</b>._unsubscribeMission(g,"failed");},unloadMissions:<b>function </b>(){<b>this</b>._missions.forEach(<b>function </b>(g,h){<b>this</b>._unloadMission(h);},<b>this</b>);<b>this</b>._missions=[];},getMission:<b>function </b>(g){<b>return</b> <b>this</b>._missions[c.isUndefined(g)?<b>this</b>._missionIndex:g];},getNextMission:<b>function </b>(){<b>return</b> <b>this</b>.getMission(++<b>this</b>._missionIndex);},hasNextMission:<b>function </b>(){<b>return</b>(<b>this</b>._missionIndex+1)&lt;<b>this</b>._missions.length;},on:<b>function </b>(g,h){<b>this</b>._onMission[g]=h;},getMissionIndex:<b>function </b>(){<b>return</b> <b>this</b>._missionIndex;},reset:<b>function </b>(){<b>this</b>._missionIndex=-1;}};}());

</pre>
<hr/>
</BODY>
</HTML>
